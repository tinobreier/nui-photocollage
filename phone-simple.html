<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phone - Simple Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: monospace;
      background: #000;
      color: #0f0;
      padding: 20px;
    }
    #log {
      white-space: pre-wrap;
      font-size: 12px;
      margin-bottom: 20px;
    }
    #video {
      width: 100%;
      max-width: 640px;
      border: 2px solid #0f0;
    }
    .error {
      color: #f00;
    }
    .success {
      color: #0f0;
    }
    .info {
      color: #ff0;
    }
  </style>
</head>
<body>
  <h1>Simple Camera Test</h1>
  <div id="log"></div>
  <video id="video" autoplay playsinline></video>

  <script type="module">
    import * as Comlink from "https://unpkg.com/comlink/dist/esm/comlink.mjs";

    const logDiv = document.getElementById('log');
    const video = document.getElementById('video');

    function log(message, type = 'info') {
      const line = document.createElement('div');
      line.className = type;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(line);
      console.log(message);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    log('Starting simple camera test...', 'info');

    // Test 1: Check if getUserMedia is available
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      log('ERROR: getUserMedia not supported!', 'error');
    } else {
      log('✓ getUserMedia is available', 'success');
    }

    // Test 2: Request camera
    async function testCamera() {
      try {
        log('Requesting camera access...', 'info');

        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });

        log('✓ Camera stream acquired!', 'success');

        video.srcObject = stream;

        video.onloadedmetadata = () => {
          log(`✓ Video started: ${video.videoWidth}x${video.videoHeight}`, 'success');
          video.play();
        };

        // Test 3: Try to load AprilTag worker
        setTimeout(testWorker, 2000);

      } catch (error) {
        log(`✗ Camera error: ${error.name} - ${error.message}`, 'error');
      }
    }

    // Test 4: Test Web Worker with Debug Version
    function testWorker() {
      try {
        log('Testing Web Worker (DEBUG VERSION)...', 'info');
        log('Using /lib/apriltag-debug.js for detailed logging', 'info');

        // Add cache buster to force reload
        const cacheBuster = Date.now();
        const worker = new Worker(`/lib/apriltag-debug.js?v=${cacheBuster}`);

        worker.onmessage = (e) => {
          const data = e.data;

          if (data.type === 'status') {
            log(`[Worker] ${data.message}`, 'success');
          } else if (data.type === 'error') {
            log(`[Worker ERROR] ${data.message}`, 'error');
            if (data.error) {
              log(`  Error details: ${data.error}`, 'error');
            }
            if (data.stack) {
              log(`  Stack: ${data.stack}`, 'error');
            }
          } else {
            log(`[Worker] ${JSON.stringify(data)}`, 'info');
          }
        };

        worker.onerror = (error) => {
          log(`✗ Worker error event: ${error.message}`, 'error');
          log(`  at ${error.filename}:${error.lineno}:${error.colno}`, 'error');
        };

        log('✓ Worker created, waiting for status messages...', 'success');

        // Wait 3 seconds for worker to load, then try to instantiate
        setTimeout(() => {
          log('Now attempting to instantiate AprilTag detector...', 'info');
          testComlinkInitialization(worker);
        }, 3000);

        // Give it 20 seconds total
        setTimeout(() => {
          log('Worker test timeout (20s) - check messages above', 'info');
        }, 20000);

      } catch (error) {
        log(`✗ Worker creation failed: ${error.message}`, 'error');
        log(`  Error: ${error.toString()}`, 'error');
      }
    }

    // Test 5: Try to instantiate the Apriltag class via Comlink
    async function testComlinkInitialization(worker) {
      try {
        log('Wrapping worker with Comlink...', 'info');
        const Apriltag = Comlink.wrap(worker);

        log('Creating Apriltag instance (this should trigger WASM loading)...', 'info');

        // Create detector instance with callback
        const apriltag = await new Apriltag(Comlink.proxy(() => {
          log('✓✓✓ CALLBACK RECEIVED - Detector is ready!', 'success');
        }));

        log('✓ Apriltag instance created', 'success');

      } catch (error) {
        log(`✗ Comlink initialization failed: ${error.message}`, 'error');
        log(`  Error: ${error.toString()}`, 'error');
        if (error.stack) {
          log(`  Stack: ${error.stack}`, 'error');
        }
      }
    }

    // Start test
    testCamera();
  </script>
</body>
</html>
